---
title: "regression"
author: "Xiaoyang Li & Jingyu Fu"
date: "2019/12/1"
output: github_document
---

```{r setup, include=FALSE}

library(viridis)
library(patchwork)
library(readxl)
library(countrycode)
library(HH)
library(modelr)
library(mgcv)
library(tidyverse)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 12, 
  fig.asp = .618,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

## Data cleaning 
Add coutrycode
```{r}
df = read_xls("data/Chapter2OnlineData.xls") %>% 
  janitor::clean_names()

df = df %>% 
  mutate(continent = countrycode(sourcevar = country_name,
                                 origin = "country.name",
                                 destination = "continent")) %>% 
  select(continent, country_name, everything()) %>% 
  drop_na(continent) %>% 
  rename(gdp = log_gdp_per_capita)
view(df)
```


## Building model
```{r}
lm1 = lm(life_ladder ~ gdp, data = df)
lm2 = lm(life_ladder ~ generosity, data = df)
lm3 = lm(life_ladder ~ gdp + generosity, data = df)
lm4 = lm(life_ladder ~ gdp*generosity, data = df)

sm1 = mgcv::gam(life_ladder ~ s(gdp), data = df)
sm2 = mgcv::gam(life_ladder ~ s(generosity), data = df)
sm3 = mgcv::gam(life_ladder ~ s(gdp) + s(generosity), data = df)
```

```{r}
summary(lm1)
summary(lm2)
summary(lm3)
summary(lm4)

summary(sm1)
summary(sm2)
summary(sm3)
```

## Diagnostic
```{r}
# check residual assupmtion
plot(lm1)
plot(lm2)
plot(lm3)
plot(lm4)
plot(sm1)
plot(sm2)
plot(sm3)
```

## Cross Validation

```{r}
cv_df = df %>% 
  select(life_ladder, gdp, generosity)


cv_df =
  crossv_mc(cv_df, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(lm1 = map(train, ~lm(life_ladder ~ gdp, data = .x)),
         lm2 = map(train, ~lm(life_ladder ~ generosity, data = .x)),
         lm3 = map(train, ~lm(life_ladder ~ gdp + generosity, data = .x)),
         sm1 = map(train, ~mgcv::gam(life_ladder ~ s(gdp), data = .x)),
         sm2 = map(train, ~mgcv::gam(life_ladder ~ s(generosity), data = .x)),
         sm3 = map(train, ~mgcv::gam(life_ladder ~ s(gdp) + s(generosity), data = .x))
         ) %>% 
  mutate(rmse_l1 = map2_dbl(lm1, test, ~rmse(model = .x, data = .y)),
         rmse_l2 = map2_dbl(lm2, test, ~rmse(model = .x, data = .y)),
         rmse_l3 = map2_dbl(lm3, test, ~rmse(model = .x, data = .y)),
         rmse_s1 = map2_dbl(sm1, test, ~rmse(model = .x, data = .y)),
         rmse_s2 = map2_dbl(sm2, test, ~rmse(model = .x, data = .y)),
         rmse_s3 = map2_dbl(sm3, test, ~rmse(model = .x, data = .y))
         )    
         
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```


## Results and Discussion

To explore what are the key variables that influence life ladder, we built four different linear regression models. Model 1 describes assocaition between gdp and life ladder. Model 2 describes association between generosity and life ladder. Model 3 describes an association in which both gdp and generosity together contribute to life ladder. Model 4 indifactes that the interaction of gdp and generosity contributes to life ladder . 

Simulation for those models indicate 

Summary for those models indicate that 

Diagnostic for those models indicate that

Corss validations for those models indicate that model1 and 3 work much better than model 2. Therefore there might be a stronger linear association between gdp and life ladder, and linear assocaition for life ladder versus gdp and generosity. 









